<!doctype html>
<html lang="ru">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>–õ–æ–≥-–ø–∞–Ω–µ–ª—å</title>
        <style>
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                max-width: 800px;
                margin: 40px auto;
                padding: 0 20px;
                background-color: #f9f9fb;
                color: #333;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
            }
            .controls {
                text-align: center;
                margin: 20px 0;
            }
            #start-btn {
                padding: 12px 24px;
                font-size: 16px;
                background-color: #3498db;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                transition: background-color 0.3s;
            }
            #start-btn:hover {
                background-color: #2980b9;
            }
            #start-btn:disabled {
                background-color: #bdc3c7;
                cursor: not-allowed;
            }
            .log-container {
                margin-top: 20px;
            }
            label {
                display: block;
                margin-bottom: 8px;
                font-weight: bold;
                color: #2c3e50;
            }
            #log-output {
                width: 100%;
                height: 300px;
                padding: 12px;
                font-family: monospace;
                font-size: 14px;
                background-color: #2d2d2d;
                color: #f8f8f2;
                border: 1px solid #555;
                border-radius: 6px;
                resize: none;
                overflow-y: auto;
                white-space: pre-wrap;
            }
        </style>
    </head>
    <body>
        <h1>üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>

        <div class="controls">
            <button id="start-btn">–ù–∞—á–∞—Ç—å</button>
        </div>

        <div class="log-container">
            <label for="log-output">–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π:</label>
            <textarea id="log-output" readonly></textarea>
        </div>

        <script>
            const logOutput = document.getElementById("log-output");
            const startBtn = document.getElementById("start-btn");
            let eventSource = null;

            function appendLog(message) {
                const now = new Date().toLocaleTimeString();
                logOutput.value += `[${now}] ${message}\n`;
                logOutput.scrollTop = logOutput.scrollHeight;
            }

            function startProcess() {
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
                if (startBtn.disabled) return;

                startBtn.disabled = true;
                logOutput.value = "";
                appendLog("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø–æ—Ç–æ–∫—É –ª–æ–≥–æ–≤...");

                // 1. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º SSE ‚Äî –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ /start!
                if (eventSource) eventSource.close();
                eventSource = new EventSource("/logs");

                eventSource.onopen = () => {
                    appendLog("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...");
                    // 2. –¢–æ–ª—å–∫–æ —Ç–µ–ø–µ—Ä—å ‚Äî POST /start
                    fetch("/start", { method: "POST" })
                        .then((response) => {
                            if (!response.ok)
                                throw new Error(`HTTP ${response.status}`);
                        })
                        .catch((err) => {
                            appendLog(`–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ${err.message}`);
                            cleanup();
                        });
                };

                eventSource.onmessage = (e) => {
                    const msg = e.data.trim();
                    appendLog(msg);

                    if (
                        msg.includes("–í –¥–æ—Å—Ç—É–ø–µ –æ—Ç–∫–∞–∑–∞–Ω–æ!") ||
                        msg.includes("–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω!")
                    ) {
                        setTimeout(cleanup, 500); // –Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    }
                };

                eventSource.onerror = (err) => {
                    appendLog("‚ùå –û—à–∏–±–∫–∞ SSE: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ");
                    cleanup();
                };

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —á–µ—Ä–µ–∑ —Ç–∞–π–º–∞—É—Ç (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø—Ä–∏—Å–ª–∞–ª "üîö")
                const fallbackTimeout = setTimeout(() => {
                    appendLog("‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è");
                    cleanup();
                }, 30_000); // 30 —Å–µ–∫—É–Ω–¥

                function cleanup() {
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                    clearTimeout(fallbackTimeout);
                    startBtn.disabled = false;
                }
            }

            startBtn.addEventListener("click", startProcess);

            // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–æ–∂–∏–¥–∞–Ω–∏–µ"
            appendLog(
                '–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å", —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É.',
            );
        </script>
    </body>
</html>
