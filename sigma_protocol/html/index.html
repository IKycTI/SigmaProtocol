<!doctype html>
<html lang="ru">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>–õ–æ–≥-–ø–∞–Ω–µ–ª—å</title>
        <style>
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                max-width: 800px;
                margin: 40px auto;
                padding: 0 20px;
                background-color: #f9f9fb;
                color: #333;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
            }
            .controls {
                text-align: center;
                margin: 20px 0;
            }
            #start-btn {
                padding: 12px 24px;
                font-size: 16px;
                background-color: #3498db;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                transition: background-color 0.3s;
            }
            #start-btn:hover {
                background-color: #2980b9;
            }
            #start-btn:disabled {
                background-color: #bdc3c7;
                cursor: not-allowed;
            }
            .log-container {
                margin-top: 20px;
            }
            label {
                display: block;
                margin-bottom: 8px;
                font-weight: bold;
                color: #2c3e50;
            }
            #log-output {
                width: 100%;
                height: 300px;
                padding: 12px;
                font-family: monospace;
                font-size: 14px;
                background-color: #2d2d2d;
                color: #f8f8f2;
                border: 1px solid #555;
                border-radius: 6px;
                resize: none;
                overflow-y: auto;
                white-space: pre-wrap;
            }
        </style>
    </head>
    <body>
        <h1>üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>

        <div class="controls">
            <button id="start-btn">–ù–∞—á–∞—Ç—å</button>
        </div>

        <div class="log-container">
            <label for="log-output">–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π:</label>
            <textarea id="log-output" readonly></textarea>
        </div>

        <script>
            const logOutput = document.getElementById("log-output");
            const startBtn = document.getElementById("start-btn");
            let eventSource = null;

            function appendLog(message) {
                const now = new Date().toLocaleTimeString();
                logOutput.value += `[${now}] ${message}\n`;
                logOutput.scrollTop = logOutput.scrollHeight;
            }

            function startProcess() {
                startBtn.disabled = true;
                logOutput.value = ""; // –æ—á–∏—â–∞–µ–º –ª–æ–≥–∏
                appendLog("–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∑–∞–ø—É—Å–∫...");

                // 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST /start
                fetch("/start", { method: "POST" })
                    .then((response) => {
                        if (!response.ok) throw new Error("–ó–∞–ø—É—Å–∫ –Ω–µ —É–¥–∞–ª—Å—è");
                        appendLog("‚úÖ –ó–∞–¥–∞—á–∞ –∑–∞–ø—É—â–µ–Ω–∞. –û–∂–∏–¥–∞–Ω–∏–µ –ª–æ–≥–æ–≤...");

                        // 2. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ SSE-–ø–æ—Ç–æ–∫—É
                        if (eventSource) eventSource.close();
                        eventSource = new EventSource("/logs");

                        eventSource.onmessage = (e) => {
                            appendLog(e.data);
                        };

                        eventSource.onerror = (err) => {
                            appendLog("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ª–æ–≥–∞–º");
                            eventSource.close();
                            startBtn.disabled = false;
                        };
                    })
                    .catch((err) => {
                        appendLog(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`);
                        startBtn.disabled = false;
                    });
            }

            startBtn.addEventListener("click", startProcess);

            // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–æ–∂–∏–¥–∞–Ω–∏–µ"
            appendLog(
                '–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å", —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É.',
            );
        </script>
    </body>
</html>
